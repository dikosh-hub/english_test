<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- (–°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–µ –∂–µ, –¥–æ–±–∞–≤–ª—è—é –ø–∞—Ä—É –Ω–æ–≤—ã—Ö –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è) -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–≠–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω–æ–µ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
    <script src="data.js"></script>
    <style>
        /* ... (–≤–µ—Å—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π CSS) ... */
        :root {
            --primary: #3b82f6; --primary-dark: #2563eb; --background: #f1f5f9;
            --surface: #ffffff; --text-dark: #0f172a; --text-light: #64748b;
            --green: #10b981; --red: #ef4444; --shadow: 0 4px 15px -3px rgb(0 0 0 / 0.1); --radius: 16px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--background); color: var(--text-dark); margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; padding: 15px; padding-bottom: env(safe-area-inset-bottom); }
        .container { width: 100%; max-width: 600px; background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; position: relative; height: 100%; }
        .screen { display: none; flex-direction: column; padding: 1.5rem; animation: fadeIn 0.3s ease-out; height: 100%; overflow: hidden; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1, h2 { text-align: center; margin: 0; font-size: 1.5rem; color: var(--text-dark); }
        #menu-root { overflow-y: auto; flex-grow: 1; padding-bottom: 20px; padding-top: 10px; display: flex; flex-direction: column; gap: 12px; }
        .menu-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 18px; cursor: pointer; transition: transform 0.1s, background 0.1s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); flex-shrink: 0; }
        .menu-card:active { transform: scale(0.98); background: #f8fafc; }
        .menu-card h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .stat-text { font-size: 0.9rem; color: var(--text-light); }
        .menu-card.mix { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; border: none; }
        .menu-card.resume { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; }
        .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9; flex-shrink: 0; }
        .btn-icon { background: #eff6ff; border: none; font-size: 1rem; font-weight: 600; color: var(--primary); padding: 8px 12px; cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 5px; }
        .subject-badge { font-size: 0.9rem; font-weight: 700; color: var(--text-dark); text-align: center; max-width: 50%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .progress-block { margin-bottom: 20px; flex-shrink: 0; }
        .counter-label { text-align: center; font-size: 0.9rem; color: var(--text-light); margin-bottom: 5px; }
        .track { height: 6px; background: #e2e8f0; border-radius: 10px; overflow: hidden; }
        .fill { height: 100%; background: var(--primary); width: 0; transition: width 0.3s; }
        .q-area { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; margin-bottom: 10px; }
        .question-text { font-size: 1.25rem; font-weight: 600; line-height: 1.4; margin-bottom: 25px; }
        .options-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .option { padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; font-size: 1rem; display: flex; align-items: flex-start; }
        .option.selected { background: #eff6ff; border-color: var(--primary); color: var(--primary-dark); }
        .circle { min-width: 22px; height: 22px; border: 2px solid #cbd5e1; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; }
        .option.selected .circle { border-color: var(--primary); }
        .option.selected .circle::after { content: ''; width: 12px; height: 12px; background: var(--primary); border-radius: 50%; }
        .footer { margin-top: auto; display: flex; gap: 15px; flex-shrink: 0; padding-top: 10px; border-top: 1px solid #f1f5f9; }
        .btn-nav { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-nav.prev { background: #e2e8f0; color: #475569; }
        .btn-nav.next { background: var(--primary); color: white; }
        .btn-nav.finish { background: #0f172a; color: white; }
        .res-header-fixed { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid #f1f5f9; }
        .score-box { text-align: center; padding: 20px; background: #f8fafc; border-radius: 16px; margin: 15px 0; }
        .score-val { font-size: 3rem; font-weight: 800; color: var(--primary); }
        .review-box { flex-grow: 1; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; }
        .review-item { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; }
        .review-item.good { background: #f0fdf4; border-left: 4px solid var(--green); }
        .review-item.bad { background: #fef2f2; border-left: 4px solid var(--red); }
        
        /* –ö–Ω–æ–ø–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ */
        .sync-block { display: flex; gap: 10px; margin-top: 10px; }
        .btn-small { font-size: 0.75rem; padding: 5px 10px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div id="scr-home" class="screen active">
        <h1>–°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–µ –¢–µ—Å—Ç—ã</h1>
        <div class="sync-block">
            <button class="btn-small" onclick="App.exportSession()">üì§ –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
            <button class="btn-small" onclick="App.importSession()">üì• –í—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
        </div>
        <div id="menu-root"></div>
    </div>

    <div id="scr-quiz" class="screen">
        <div class="header-nav">
            <button class="btn-icon" onclick="App.goHomeSafe()">üè† –ú–µ–Ω—é</button>
            <span class="subject-badge" id="subj-name">...</span>
            <button class="btn-icon" id="btn-giveup" onclick="App.finishEarly()" style="color: #ef4444; background: #fef2f2;">üè≥ –°–¥–∞—Ç—å—Å—è</button>
        </div>
        <div class="progress-block">
            <div class="counter-label" id="counter">1 / 10</div>
            <div class="track"><div class="fill" id="fill-bar"></div></div>
        </div>
        <div class="q-area">
            <div class="question-text" id="q-text">...</div>
            <div class="options-list" id="opt-root"></div>
        </div>
        <div class="footer">
            <button class="btn-nav prev" id="btn-prev" onclick="App.prev()">‚¨Ö –ù–∞–∑–∞–¥</button>
            <button class="btn-nav next" id="btn-next" onclick="App.next()">–î–∞–ª–µ–µ ‚û°</button>
            <button class="btn-nav finish" id="btn-finish" onclick="App.finish()" style="display:none">‚úÖ –ò—Ç–æ–≥–∏</button>
        </div>
    </div>

    <div id="scr-res" class="screen">
        <div class="res-header-fixed">
            <button class="btn-icon" onclick="App.goHome()">üè† –í –º–µ–Ω—é</button>
            <h2>–ò—Ç–æ–≥–∏</h2>
            <div style="width: 70px;"></div>
        </div>
        <div class="score-box">
            <div class="score-val" id="res-score">0%</div>
            <div id="res-text">0/0 –≤–µ—Ä–Ω–æ</div>
        </div>
        <div class="review-box" id="res-log"></div>
    </div>
</div>

<script>
    const App = {
        data: [], cursor: 0, answers: {}, activeKey: '',
        
        init() {
            if(typeof QUESTIONS_DB === 'undefined') { alert("–û—à–∏–±–∫–∞: data.js –Ω–µ –Ω–∞–π–¥–µ–Ω!"); return; }
            this.renderMenu();
        },

        // --- –õ–û–ì–ò–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø ---
        saveProgress() {
            const session = {
                activeKey: this.activeKey,
                cursor: this.cursor,
                answers: this.answers,
                data: this.data // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–º–µ—à–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –ø–æ—Ä—è–¥–æ–∫ –Ω–µ —Å–±–∏–ª—Å—è
            };
            localStorage.setItem('quiz_session_v1', JSON.stringify(session));
        },

        clearSession() {
            localStorage.removeItem('quiz_session_v1');
        },

        resumeSession() {
            const raw = localStorage.getItem('quiz_session_v1');
            if(!raw) return;
            const session = JSON.parse(raw);
            this.activeKey = session.activeKey;
            this.cursor = session.cursor;
            this.answers = session.answers;
            this.data = session.data;
            this.showScr('scr-quiz');
            this.renderQ();
        },

        exportSession() {
            const raw = localStorage.getItem('quiz_session_v1');
            if(!raw) return alert("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.");
            navigator.clipboard.writeText(raw);
            alert("–ö–æ–¥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ —Å–µ–±–µ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –∏ –≤—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.");
        },

        importSession() {
            const code = prompt("–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:");
            if(!code) return;
            try {
                JSON.parse(code); // –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
                localStorage.setItem('quiz_session_v1', code);
                this.renderMenu();
                alert("–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω! –ù–∞–∂–º–∏—Ç–µ '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç–µ—Å—Ç'.");
            } catch(e) { alert("–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥."); }
        },

        // --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
        renderMenu() {
            const root = document.getElementById('menu-root');
            root.innerHTML = '';

            // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è
            const saved = localStorage.getItem('quiz_session_v1');
            if(saved) {
                const session = JSON.parse(saved);
                const count = Object.keys(session.answers).length;
                const resumeBtn = document.createElement('div');
                resumeBtn.className = 'menu-card resume';
                resumeBtn.innerHTML = `<h3>‚è≥ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç–µ—Å—Ç</h3><div class="stat-text">–û—Ç–≤–µ—á–µ–Ω–æ: ${count} –∏–∑ ${session.data.length}</div>`;
                resumeBtn.onclick = () => this.resumeSession();
                root.appendChild(resumeBtn);
            }

            // MIX
            const mix = document.createElement('div');
            mix.className = 'menu-card mix';
            mix.innerHTML = `<h3>üîÄ –û–±—â–∏–π –¢–µ—Å—Ç (Mix)</h3><div class="stat-text">–í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –≤–ø–µ—Ä–µ–º–µ—à–∫—É</div>`;
            mix.onclick = () => this.start('mix');
            root.appendChild(mix);

            const hist = JSON.parse(localStorage.getItem('qz_history')) || {};
            Object.keys(QUESTIONS_DB).forEach(k => {
                const item = QUESTIONS_DB[k];
                const sc = hist[k] || 0;
                const el = document.createElement('div');
                el.className = 'menu-card';
                el.innerHTML = `<h3>${item.title.split('(')[0]}</h3><div class="stat-text">–†–µ–∫–æ—Ä–¥: ${sc}%</div>`;
                el.onclick = () => this.start(k);
                root.appendChild(el);
            });
        },

        shuffle(arr) { return arr.map(v => ({v, r: Math.random()})).sort((a,b)=>a.r - b.r).map(d=>d.v); },

        start(key) {
            if(localStorage.getItem('quiz_session_v1')) {
                if(!confirm("–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç. –ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π? (–ü—Ä–æ–≥—Ä–µ—Å—Å —Å—Ç–∞—Ä–æ–≥–æ —É–¥–∞–ª–∏—Ç—Å—è)")) return;
            }
            this.activeKey = key;
            this.cursor = 0;
            this.answers = {};

            let qList = [];
            if(key === 'mix') Object.values(QUESTIONS_DB).forEach(d => qList.push(...d.data));
            else qList = QUESTIONS_DB[key].data;

            this.data = this.shuffle(qList).map((qItem, i) => {
                const opts = qItem.a.map((txt, idx) => ({ txt, correct: idx===0 }));
                return { id: i, q: qItem.q, opts: this.shuffle(opts) };
            });

            this.saveProgress();
            this.showScr('scr-quiz');
            this.renderQ();
        },

        renderQ() {
            const item = this.data[this.cursor];
            const tot = this.data.length;

            document.getElementById('subj-name').innerText = this.activeKey === 'mix' ? "–°–ú–ï–®–ê–ù–ù–´–ô –¢–ï–°–¢" : QUESTIONS_DB[this.activeKey].title;
            document.getElementById('counter').innerText = `${this.cursor+1} / ${tot}`;
            document.getElementById('fill-bar').style.width = `${((this.cursor+1)/tot)*100}%`;
            document.getElementById('q-text').innerText = item.q;

            const list = document.getElementById('opt-root');
            list.innerHTML = '';
            item.opts.forEach((o, idx) => {
                const row = document.createElement('div');
                row.className = 'option' + (this.answers[this.cursor] === idx ? ' selected' : '');
                row.innerHTML = `<div class="circle"></div><div>${o.txt}</div>`;
                row.onclick = () => {
                    this.answers[this.cursor] = idx;
                    this.saveProgress(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–∫–∞
                    this.renderQ(); 
                };
                list.appendChild(row);
            });

            const isLast = this.cursor === tot - 1;
            document.getElementById('btn-prev').style.visibility = this.cursor === 0 ? 'hidden' : 'visible';
            document.getElementById('btn-next').style.display = isLast ? 'none' : 'flex';
            document.getElementById('btn-finish').style.display = isLast ? 'flex' : 'none';
            document.getElementById('btn-giveup').style.display = isLast ? 'none' : 'flex';
        },

        next() { if(this.cursor < this.data.length-1) { this.cursor++; this.saveProgress(); this.renderQ(); } },
        prev() { if(this.cursor > 0) { this.cursor--; this.saveProgress(); this.renderQ(); } },

        goHomeSafe() {
            if(Object.keys(this.answers).length > 0) {
                if(confirm("–í—ã–π—Ç–∏ –≤ –º–µ–Ω—é? –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∑–∂–µ.")) this.goHome();
            } else this.goHome();
        },

        finishEarly() {
            if(confirm("–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç —Å–µ–π—á–∞—Å –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç?")) this.finish();
        },

        finish() {
            let ok = 0;
            const log = document.getElementById('res-log');
            log.innerHTML = '';

            this.data.forEach((item, i) => {
                const uIdx = this.answers[i];
                let isRight = (uIdx !== undefined && item.opts[uIdx].correct);
                if(isRight) ok++;

                const rightTxt = item.opts.find(o => o.correct).txt;
                const div = document.createElement('div');
                div.className = `review-item ${isRight?'good':'bad'}`;
                div.innerHTML = `
                    <div style="font-weight:600; margin-bottom:4px">${i+1}. ${item.q}</div>
                    <div style="font-size:0.9em">${isRight?'‚úÖ':'‚ùå'} ${rightTxt}</div>
                `;
                log.appendChild(div);
            });

            const pct = Math.round((ok / this.data.length)*100);
            document.getElementById('res-score').innerText = pct + '%';
            document.getElementById('res-text').innerText = `${ok} / ${this.data.length} –≤–µ—Ä–Ω–æ`;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∫–æ—Ä–¥
            if(this.activeKey !== 'mix') {
                const h = JSON.parse(localStorage.getItem('qz_history')) || {};
                if(pct > (h[this.activeKey]||0)) {
                    h[this.activeKey] = pct;
                    localStorage.setItem('qz_history', JSON.stringify(h));
                }
            }

            this.clearSession(); // –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω ‚Äî —É–¥–∞–ª—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫
            this.showScr('scr-res');
        },

        goHome() { this.renderMenu(); this.showScr('scr-home'); },
        showScr(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    };

    App.init();
</script>
</body>
</html>
